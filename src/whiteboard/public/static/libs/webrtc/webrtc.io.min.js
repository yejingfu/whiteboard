function preferOpus(e){for(var n=e.split("\r\n"),t=null,o=0;o<n.length;o++)if(-1!==n[o].search("m=audio")){t=o;break}if(null===t)return e;for(var a=0;a<n.length;a++)if(-1!==n[a].search("opus/48000")){var r=extractSdp(n[a],/:(\d+) opus\/48000/i);r&&(n[t]=setDefaultCodec(n[t],r));break}return n=removeCN(n,t),e=n.join("\r\n")}function extractSdp(e,n){var t=e.match(n);return t&&2==t.length?t[1]:null}function setDefaultCodec(e,n){for(var t=e.split(" "),o=[],a=0,r=0;r<t.length;r++)3===a&&(o[a++]=n),t[r]!==n&&(o[a++]=t[r]);return o.join(" ")}function removeCN(e,n){for(var t=e[n].split(" "),o=e.length-1;o>=0;o--){var a=extractSdp(e[o],/a=rtpmap:(\d+) CN\/\d+/i);if(a){var r=t.indexOf(a);-1!==r&&t.splice(r,1),e.splice(o,1)}}return e[n]=t.join(" "),e}function mergeConstraints(e,n){var t=e;for(var o in n.mandatory)t.mandatory[o]=n.mandatory[o];return t.optional.concat(n.optional),t}var PeerConnection=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,URL=window.URL||window.webkitURL||window.msURL||window.oURL,getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,nativeRTCIceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,nativeRTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};navigator.webkitGetUserMedia&&(webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})),function(){var e;e="undefined"==typeof module?this.rtc={}:module.exports={},e.debug=!1,e._socket=null,e._me=null,e._events={},e.on=function(n,t){e._events[n]=e._events[n]||[],e._events[n].push(t)},e.fire=function(n){var t=e._events[n],o=Array.prototype.slice.call(arguments,1);if(t)for(var a=0,r=t.length;r>a;a++)t[a].apply(null,o)},e.SERVER=function(){return navigator.mozGetUserMedia?{iceServers:[{url:"stun:23.21.150.121"}]}:{iceServers:[{url:"stun:stun.l.google.com:19302"}]}},e.peerConnections={},e.connections=[],e.streams=[],e.numStreams=0,e.initializedStreams=0,e.dataChannels={},e.dataChannelConfig={optional:[{RtpDataChannels:!0},{DtlsSrtpKeyAgreement:!0}]},e.pc_constraints={optional:[{DtlsSrtpKeyAgreement:!0}]},e.checkDataChannelSupport=function(){try{var n=new PeerConnection(e.SERVER(),e.dataChannelConfig),t=n.createDataChannel("supportCheck",{reliable:!1});return t.close(),!0}catch(o){return!1}},e.dataChannelSupport=e.checkDataChannelSupport(),e.connect=function(n,t){t=t||"",e._socket=new WebSocket(n),e._socket.onopen=function(){e._socket.send(JSON.stringify({eventName:"join_room",data:{room:t}})),e._socket.onmessage=function(n){var t=JSON.parse(n.data);e.fire(t.eventName,t.data)},e._socket.onerror=function(e){console.error("onerror"),console.error(e)},e._socket.onclose=function(){var n=e._socket.id;e.fire("disconnect stream",n),"undefined"!=typeof e.peerConnections[n]&&e.peerConnections[n].close(),delete e.peerConnections[n],delete e.dataChannels[n],delete e.connections[n]},e.on("get_peers",function(n){e.connections=n.connections,e._me=n.you,e.offerSent&&(e.createPeerConnections(),e.addStreams(),e.addDataChannels(),e.sendOffers()),e.fire("connections",e.connections)}),e.on("receive_ice_candidate",function(n){var t=new nativeRTCIceCandidate(n);e.peerConnections[n.socketId].addIceCandidate(t),e.fire("receive ice candidate",t)}),e.on("new_peer_connected",function(n){var t=n.socketId;e.connections.push(t),delete e.offerSent;for(var o=e.createPeerConnection(t),a=0;a<e.streams.length;a++){var r=e.streams[a];o.addStream(r)}}),e.on("remove_peer_connected",function(n){var t=n.socketId;e.fire("disconnect stream",t),"undefined"!=typeof e.peerConnections[t]&&e.peerConnections[t].close(),delete e.peerConnections[t],delete e.dataChannels[t],delete e.connections[t]}),e.on("receive_offer",function(n){e.receiveOffer(n.socketId,n.sdp),e.fire("receive offer",n)}),e.on("receive_answer",function(n){e.receiveAnswer(n.socketId,n.sdp),e.fire("receive answer",n)}),e.fire("connect")}},e.sendOffers=function(){for(var n=0,t=e.connections.length;t>n;n++){var o=e.connections[n];e.sendOffer(o)}},e.onClose=function(n){e.on("close_stream",function(){e.fire("close_stream",n)})},e.createPeerConnections=function(){for(var n=0;n<e.connections.length;n++)e.createPeerConnection(e.connections[n])},e.createPeerConnection=function(n){var t=e.pc_constraints;e.dataChannelSupport&&(t=e.dataChannelConfig);var o=e.peerConnections[n]=new PeerConnection(e.SERVER(),t);return o.onicecandidate=function(t){t.candidate&&e._socket.send(JSON.stringify({eventName:"send_ice_candidate",data:{label:t.candidate.sdpMLineIndex,candidate:t.candidate.candidate,socketId:n}})),e.fire("ice candidate",t.candidate)},o.onopen=function(){e.fire("peer connection opened")},o.onaddstream=function(t){e.fire("add remote stream",t.stream,n)},e.dataChannelSupport&&(o.ondatachannel=function(t){e.debug&&console.log("data channel connecting "+n),e.addDataChannel(n,t.channel)}),o},e.sendOffer=function(n){var t=e.peerConnections[n],o={optional:[],mandatory:{MozDontOfferDataChannel:!0}};if(navigator.webkitGetUserMedia)for(var a in o.mandatory)-1!=a.indexOf("Moz")&&delete o.mandatory[a];o=mergeConstraints(o,sdpConstraints),t.createOffer(function(o){o.sdp=preferOpus(o.sdp),t.setLocalDescription(o),e._socket.send(JSON.stringify({eventName:"send_offer",data:{socketId:n,sdp:o}}))},null,sdpConstraints)},e.receiveOffer=function(n,t){e.peerConnections[n];e.sendAnswer(n,t)},e.sendAnswer=function(n,t){var o=e.peerConnections[n];o.setRemoteDescription(new nativeRTCSessionDescription(t)),o.createAnswer(function(t){o.setLocalDescription(t),e._socket.send(JSON.stringify({eventName:"send_answer",data:{socketId:n,sdp:t}}));o.remoteDescription},null,sdpConstraints)},e.receiveAnswer=function(n,t){var o=e.peerConnections[n];o.setRemoteDescription(new nativeRTCSessionDescription(t))},e.createStream=function(n,t,o){var a;t=t||function(){},o=o||function(){},a={video:!!n.video,audio:!!n.audio},getUserMedia?(e.numStreams++,getUserMedia.call(navigator,a,function(n){e.streams.push(n),e.initializedStreams++,t(n),e.initializedStreams===e.numStreams&&e.fire("ready")},function(e){alert("Could not connect stream."),o(e)})):alert("webRTC is not yet supported in this browser.")},e.addStreams=function(){for(var n=0;n<e.streams.length;n++){var t=e.streams[n];for(var o in e.peerConnections)e.peerConnections[o].addStream(t)}},e.attachStream=function(n,t){"string"==typeof t&&(t=document.getElementById(t)),navigator.mozGetUserMedia?(e.debug&&console.log("Attaching media stream"),t.mozSrcObject=n,t.play()):t.src=webkitURL.createObjectURL(n)},e.createDataChannel=function(n,t){if(!e.dataChannelSupport)return void alert("webRTC data channel is not yet supported in this browser, or you must turn on experimental flags");var o,a;if("string"==typeof n)o=n,a=e.peerConnections[n];else{a=n,o=void 0;for(var r in e.peerConnections)e.peerConnections[r]===a&&(o=r)}if(!o)throw new Error("attempt to createDataChannel with unknown id");if(!(a&&a instanceof PeerConnection))throw new Error("attempt to createDataChannel without peerConnection");t=t||"fileTransfer"||String(o);var i,s={reliable:!1};try{e.debug&&console.log("createDataChannel "+o),i=a.createDataChannel(t,s)}catch(c){throw e.debug&&console.log("seems that DataChannel is NOT actually supported!"),c}return e.addDataChannel(o,i)},e.addDataChannel=function(n,t){return t.onopen=function(){e.debug&&console.log("data stream open "+n),e.fire("data stream open",t)},t.onclose=function(){delete e.dataChannels[n],delete e.peerConnections[n],delete e.connections[n],e.debug&&console.log("data stream close "+n),e.fire("data stream close",t)},t.onmessage=function(o){e.debug&&console.log("data stream message "+n),e.fire("data stream data",t,o.data)},t.onerror=function(o){e.debug&&console.log("data stream error "+n+": "+o),e.fire("data stream error",t,o)},e.dataChannels[n]=t,t},e.addDataChannels=function(){if(e.dataChannelSupport)for(var n in e.peerConnections)e.createDataChannel(n)},e.on("ready",function(){e.createPeerConnections(),e.addStreams(),e.addDataChannels(),e.sendOffers(),e.offerSent=!0})}.call(this);