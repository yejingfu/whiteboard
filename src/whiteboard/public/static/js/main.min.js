define("selectionset",[],function(){var e=0,t=function(t,n,r,i){this.path=t,this.segment=n,this.type=r,this.id=i||++e};t.prototype={};var n=function(){this.items={}};return n.prototype={add:function(e){if(e.id in this.items)return;this.items[e.id]=e,e.path&&(e.path.selected=!0)},remove:function(e){this.items[e]&&(this.items[e].path&&(this.items[e].path.selected=!1),delete this.items[e])},addPath:function(e){var n=new t(e,null,null,"path:"+e.id);this.add(n)},removePath:function(e){this.remove("path:"+e.id)},removeAll:function(){var e;for(e in this.items)this.items[e].path&&(this.items[e].path.selected=!1);this.items={}},empty:function(){return Object.keys(this.items).length===0}},{createItem:function(e,n,r){return new t(e,n,r,"path:"+e.id)},createSelectionSet:function(){return new n}}}),define("util",[],function(){var e={hello:function(){return"Hello World"},uniqueID:function(){return Math.random().toString(36).substr(2,9)}};return e}),define("document",["selectionset","util"],function(e,t){var n=function(e,n){this.path=e,this.key=n||t.uniqueID()};n.prototype={toJsonObject:function(){return{key:this.key,path:this.path.exportJSON({asString:!0,precision:5})}},fromJsonObject:function(e){this.key=e.key,this.path=new paper.Path,this.path.importJSON(e.path)},serializePath:function(){return this.path.exportJSON({asString:!0,precision:5})},deserializePath:function(e){this.path&&this.path.remove(),this.path=new paper.Path,this.path.importJSON(e)}};var r=function(e){this.doc=e,this.shapes={},this.addedShapes=[],this.removedShapes=[],this.updatedShapes=[]};r.prototype={addPath:function(e){if(!this.existPath(e)){var t=this.addShapeItem(new n(e));return t}},removePath:function(e){var t;this.traverseShapes(!1,function(n){if(n.path===e)return t=n,!0}),t&&this.removeShapeItem(t.key)},updatePath:function(e,t,n){var r;this.traverseShapes(!1,function(t){if(t.path===e)return r=t,!0}),r&&this.updateShapeItem(r,t,n)},addShapeItem:function(e){var t=e.key;if(!(t in this.shapes)){this.shapes[t]=e;if(this.doc.isChanging){var n=this.findInArray(e,this.removedShapes);n>=0&&this.removedShapes.splice(n,1),this.addedShapes.push(e)}}},updateShapeItem:function(e,t,n){var r=e.key;r in this.shapes&&(e.path[t]=n,this.doc.isChanging&&this.updatedShapes.push({key:e.key,name:t,value:n}))},removeShapeItem:function(e){if(e in this.shapes){if(this.doc.isChanging){var t=this.findInArray(this.shapes[e],this.addedShapes);t>=0&&this.addedShapes.splice(t,1),this.removedShapes.push(this.shapes[e])}this.shapes[e].path.remove(),delete this.shapes[e]}},findInArray:function(e,t){for(var n=0,r=t.length;n<r;n++)if(e===t[n])return n;return-1},existPath:function(e){var t=!1;this.traverseShapes(!1,function(n){if(n.path===e)return t=!0,!0})},existShapeItem:function(e){var t;e instanceof n?t=e.key:t=e;var r=!1;return this.traverseShapes(!1,function(e){if(e.key===t)return r=!0,!0}),r},traverseShapes:function(e,t){var n=Object.keys(this.shapes),r,i=!1;for(var s=0,o=n.length;!i&&s<o;s++)e?r=n[o-s-1]:r=n[s],i=t(this.shapes[r])},toJsonObject:function(){var e={};return e.shapes=[],this.traverseShapes(!1,function(t){t instanceof n&&e.shapes.push(t.toJsonObject())}),e},fromJsonObject:function(e){if(!e||!e.shapes)return;var t=e.shapes;for(var r=0,i=t.length;r<i;r++){var s=new n;s.fromJsonObject(t[r]),this.addShapeItem(s)}}};var i=function(t){this.application=t,this.shapeRoot=new r(this),this.ss=new e.createSelectionSet,this.isChanging=!1,this.sharedDocument=null,this.shapeKeys=null};return i.prototype={beginChange:function(){console.log("Document::beginChange"),this.shapeRoot.addedShapes.length=0,this.shapeRoot.removedShapes.length=0,this.shapeRoot.updatedShapes.length=0,this.shapeKeys={};for(k in this.shapeRoot.shapes)this.shapeKeys[k]=!0;this.isChanging=!0},endChange:function(){console.log("Document::endChange");for(var e=this.shapeRoot.addedShapes.length,t=e-1;t>=0;t--){var n=this.shapeRoot.addedShapes[t].key;this.shapeKeys[n]&&this.shapeRoot.addedShapes.splice(t,1)}for(var e=this.shapeRoot.removedShapes.length,t=e-1;t>=0;t--){var n=this.shapeRoot.removedShapes[t].key;this.shapeKeys[n]||this.shapeRoot.removedShapes.splice(t,1)}this.pushSharedDeltaState(),this.isChanging=!1},initSharedDocument:function(e){var t=this;if(!e||e==="")e="unknown";sharejs.open(e,"json",function(e,n){if(e){console.error("Failed to setup sharejs connection: "+e);return}t.sharedDocument=n,t.sharedDocument.on("change",function(e){console.log("sharejs document changed: "+JSON.stringify(e)),t.pullSharedDeltaState(e)}),t.sharedDocument.created?t.saveSharedDocument():t.loadSharedDocument()})},saveSharedDocument:function(){var e=this.shapeRoot.toJsonObject();this.sharedDocument.submitOp([{p:[],od:null,oi:e}])},loadSharedDocument:function(){var e=this,t=e.sharedDocument.snapshot;e.shapeRoot.fromJsonObject(t),paper.view.update()},findInSnapshot:function(e,t){for(var n=0,r=t.shapes.length;n<r;n++)if(t.shapes[n].key===e.key)return n;return-1},pushSharedDeltaState:function(){var e=this;if(!e.sharedDocument)return;var t=e.sharedDocument.snapshot,n=t.shapes.length,r,i;e.shapeRoot.addedShapes.forEach(function(t){r={p:["shapes",n++],li:t.toJsonObject()},e.sharedDocument.submitOp([r])}),e.shapeRoot.removedShapes.forEach(function(n){i=e.findInSnapshot(n,t),i>=0&&(r={p:["shapes",i],ld:n.toJsonObject()},e.sharedDocument.submitOp([r]))}),e.shapeRoot.updatedShapes.forEach(function(n){i=e.findInSnapshot(n,t);if(i>=0&&n.key in e.shapeRoot.shapes){var s=e.shapeRoot.shapes[n.key];r={p:["shapes",i,"path"],od:null,oi:s.serializePath()},e.sharedDocument.submitOp([r])}})},pullSharedDeltaState:function(e){var t=this;if(!t.sharedDocument||!e||e.length===0)return;var r=!1;for(var i=0,s=e.length;i<s;i++){var o=e[i].p,u;if(o.length===2){var a=e[i].li,f=e[i].ld;if(a&&!t.shapeRoot.existShapeItem(a.key)){var l=new n;l.fromJsonObject(a),t.shapeRoot.addShapeItem(l),r=!0}f&&t.shapeRoot.existShapeItem(f.key)&&(t.shapeRoot.removeShapeItem(f.key),r=!0)}else if(o.length===3){var c=e[i].oi,h;if(c&&(h=t.sharedDocument.snapshot.shapes[o[1]])){var p=t.shapeRoot.shapes[h.key];p&&(p.deserializePath(c),r=!0)}}}r&&paper.view.update()}},{createDocument:function(e){return new i(e)},createShapeItem:function(e){return new n(e)}}}),define("painter",[],function(){var e={Pointer:"pointer",Stroke:"stroke",Rectangle:"rectangle",RoundRect:"roundrect",Ellipse:"ellipse",Fill:"fill",None:"none"},t=function(t){this.application=t,this.doc=t.doc,this.ss=this.doc.ss,this.canvas=null,this.tools={},this.activeTool=e.None,this.defaultStyle={strokeColor:"#000000",strokeWidth:1},this.activePath=null,this.startPoint=null,this.eatMouseUp=!1,this.maxRoundRectRadius=10,this.activeColor="#000000",this.hitOptions={segments:!0,stroke:!0,fill:!0,tolerance:3}};return t.prototype={init:function(e){console.log("Painter::init"),this.canvas=e,paper.setup(this.canvas),this.initToolbar(),paper.project.currentStyle=$.extend({},this.defaultStyle)},initToolbar:function(){console.log("Application::initToolbar()");var e=this;e.initTools();var t=$("#canvas-main").offset();$("#canvas-toolbar").css({top:t.top,left:t.left}),$("#canvas-toolbar").css("visibility","visible")},initTools:function(){var t,n=this,r=$("#canvas-toolbar"),i=function(e,t){var i='<div id="tb-'+e+'" class="toolbaritem img-'+e+'-32x32-normal"></div>';r.append(i);var s=$("#tb-"+e);s.hover(function(){n.changeToolbarItemState(e,"hover")},function(){n.changeToolbarItemState(e,"normal")}),t!==undefined&&typeof t=="function"&&s.click(function(){t()})},s=function(){r.append('<div class="toolbarsep img-seperate-32x4-normal"></div>')},o=function(t){var r=new paper.Tool;n.tools[t]=r,r.onMouseDown=function(e){n.drawBegin(t,e)},r.onMouseDrag=function(e){n.drawMove(t,e)},r.onMouseUp=function(e){n.drawEnd(t,e)},t===e.Pointer&&(r.onKeyDown=function(e){e.key==="delete"&&n.removeSelection()},r.onKeyUp=function(e){})};o(e.Pointer),o(e.Fill),o(e.Stroke),o(e.Rectangle),o(e.RoundRect),o(e.Ellipse),i("new",function(){console.log("TODO: new")}),i("save",function(){console.log("TODO: save")}),s(),i("pointer",function(){n.startTool(e.Pointer)}),i("stroke",function(){n.startTool(e.Stroke)}),i("rectangle",function(){n.startTool(e.Rectangle)}),i("roundrect",function(){n.startTool(e.RoundRect)}),i("ellipse",function(){n.startTool(e.Ellipse)}),i("fill",function(){n.startTool(e.Fill)}),s(),i("undo",function(){console.log("TODO: undo")}),i("redo",function(){console.log("TODO: redo")}),s(),i("zoomin",function(){console.log("TODO: zoomin")}),i("zoomout",function(){console.log("TODO: zoomout")}),s(),i("grid",function(){console.log("TODO: grid")}),i("ruler",function(){console.log("TODO: ruler")}),s(),i("color"),$("#tb-color").ColorPicker({color:n.activeColor,onShow:function(e){return $(e).fadeIn(500),!1},onHide:function(e){return $(e).fadeOut(500),!1},onChange:function(e,t,r){n.activeColor="#"+t,paper.project.currentStyle.strokeColor="#"+t}}),this.startTool(e.Pointer)},changeToolbarItemState:function(e,t,n){var r=$("#tb-"+e);if(!r)return;var i="img-"+e+"-32x32-normal",s="img-"+e+"-32x32-active",o="img-"+e+"-32x32-hover",u="img-"+e+"-32x32-"+t;if(!n&&r.hasClass(s))return;r.hasClass(i)&&i!==u&&r.removeClass(i),r.hasClass(s)&&s!==u&&r.removeClass(s),r.hasClass(o)&&o!==u&&r.removeClass(o),r.hasClass(u)||r.addClass(u)},startTool:function(t){this.activeTool!==e.None&&this.endTool(),t==e.Fill&&this.deselectPath(),this.tools[t].activate(),this.activeTool=t,this.changeToolbarItemState(t,"active")},endTool:function(){this.changeToolbarItemState(this.activeTool,"normal",!0),this.activeTool=e.None},addToolBarItem:function(e,t){var n=$("#canvas-toolbar"),r='<div id="tb-'+e+'" class="btn"><span class=></span></div>';n.append()},drawBegin:function(t,n){console.log("drawBegin:"+t);var r=this;r.doc.beginChange(),r.activePath=null,r.startPoint=n.point.clone();if(t===e.Pointer){var i=paper.project.hitTest(n.point,r.hitOptions);i?r.selectPath(i.item):r.deselectPath()}else t===e.Fill&&r.doc.shapeRoot.traverseShapes(!0,function(e){if(e.path&&e.path.closed&&e.path.contains(n.point))return r.doc.shapeRoot.updateShapeItem(e,"fillColor",r.activeColor),!0})},drawMove:function(t,n){console.log("drawMove:"+t);var r=this;switch(t){case e.Pointer:for(var i in r.ss.items){var s=r.ss.items[i].path;s.position=s.position.add(n.delta)}break;case e.Stroke:r.activePath||(r.activePath=r.addPath(),r.activePath.add(r.startPoint),r.activePath.add(n.point)),n.event.shiftKey?r.activePath.lastSegment.point=n.point:r.activePath.add(n.point);break;case e.Rectangle:r.activePath=r.updatePath(r.activePath,paper.Path.Rectangle(r.startPoint,n.point));break;case e.RoundRect:var o=r.maxRoundRectRadius,u=new paper.Rectangle(r.startPoint,n.point),a=u.width>u.height?u.height:u.width,o=a*.2;o>r.maxRoundRectRadius&&(o=r.maxRoundRectRadius),r.activePath=r.updatePath(r.activePath,paper.Path.Rectangle(u,o));break;case e.Ellipse:r.activePath=r.updatePath(r.activePath,paper.Path.Ellipse(new paper.Rectangle(r.startPoint,n.point)));break;default:}},drawEnd:function(t,n){console.log("drawEnd:"+t);var r=this;if(!r.activePath){r.doc.endChange();return}switch(t){case e.Stroke:if(n.event.shiftKey){r.activePath.lastSegment.remove();var i=r.activePath.firstSegment.point.add(n.point);i.x/=2,i.y/=2,r.activePath.add(i),r.activePath.add(n.point)}else r.activePath.add(n.point),r.activePath.simplify(10);break;case e.Rectangle:r.activePath=r.updatePath(r.activePath,paper.Path.Rectangle(r.startPoint,n.point));break;case e.RoundRect:var s=r.maxRoundRectRadius,o=new paper.Rectangle(r.startPoint,n.point),u=o.width>o.height?o.height:o.width,s=u*.2;s>r.maxRoundRectRadius&&(s=r.maxRoundRectRadius),r.activePath=r.updatePath(r.activePath,paper.Path.Rectangle(o,s));break;case e.Ellipse:r.activePath=r.updatePath(r.activePath,paper.Path.Ellipse(new paper.Rectangle(r.startPoint,n.point)));break;default:}r.doc.endChange()},addPath:function(e){return e||(e=new paper.Path),this.doc.shapeRoot.addPath(e),e},deletePath:function(e){if(!e)return;this.doc.shapeRoot.removePath(e)},updatePath:function(e,t){return e&&this.deletePath(e),this.addPath(t)},selectPath:function(e){if(!e){var t=this;this.doc.shapeRoot.traverseShapes(!1,function(e){e.path&&t.ss.addPath(e.path)})}else this.ss.addPath(e)},deselectPath:function(e){e?this.ss.removePath(e):this.ss.removeAll()},removeSelection:function(){this.doc.beginChange();for(k in this.ss.items)this.deletePath(this.ss.items[k].path);this.deselectPath(),this.doc.endChange()}},{create:function(e){return new t(e)}}}),define("webrtc",[],function(){var e=function(e){this.application=e,this.serverURL="ws://10.239.37.128:3001",this.localVideoId="video-local",this.parentVideoNode=$("#video-container")[0],this.localVideoNode=$("#video-local")[0],this.videoNodes={},this.channelKey,this.PeerConnection};return e.prototype={init:function(e){console.log("WebRTC::init");var t=this;t.PeerConnection=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection;if(!t.PeerConnection)return console.error("The browser does not support WebRTC, please enable it by going to chrome://flags"),!1;rtc.createStream({video:!0,audio:!0},function(e){rtc.attachStream(e,t.localVideoId),t.videoNodes[t.localVideoId]=t.localVideoNode}),t.channelKey=e,rtc.connect(t.serverURL,t.channelKey),rtc.on("add remote stream",function(e,n){console.log("add remote stream: "+n);var r=t.cloneVideo(n);rtc.attachStream(e,r.id)}),rtc.on("disconnect stream",function(e){console.log("disconnect stream: "+socketId),t.removeVideo(socketId)})},cloneVideo:function(e){var t=this,n=t.localVideoNode.cloneNode(!1);return n.id="video_remote_"+e,t.parentVideoNode.appendChild(n),t.videoNodes[n.id]=n,n},removeVideo:function(e){var t=this,n="video_remote_"+e,r=$("#"+n)[0];r&&(delete t.videoNodes[n],t.parentVideoNode.removeChild(r))}},{create:function(t){return new e(t)}}}),define("app",["document","painter","webrtc","util"],function(e,t,n,r){var i=function(){this.painter=null,this.webrtc=null,this.doc=null,this.defaultChannelKey="46a910fc-d481-41e1-b06c-26cb9a9e62c4"};return i.prototype={init:function(){var r=window.location.search,i={};if(r[0]==="?"){var s=r.substring(1).split("&");for(var o=0,u=s.length;o<u;o++){var a=s[o].split("=");i[a[0]]=a[1]}}var f=i.channel;typeof f=="string"&&(this.defaultChannelKey=f),this.doc=e.createDocument(this),this.doc.initSharedDocument(this.defaultChannelKey),this.painter=t.create(this),this.webrtc=n.create(this),this.painter.init($("#canvas-main")[0]),this.webrtc.init(this.defaultChannelKey)},run:function(){console.log("Application::run: "+r.hello())}},new i}),requirejs(["app"],function(e){e.init(),e.run()}),define("main",function(){});